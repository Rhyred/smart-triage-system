<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Triage System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Space Grotesk', 'sans-serif'],
            },
            animation: {
                'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          }
        }
      }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Space Grotesk', sans-serif; }
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        /* Utilitas untuk menyembunyikan elemen */
        .hidden-force { display: none !important; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen transition-colors duration-500 overflow-x-hidden">

    <!-- Background Gradients -->
    <div class="fixed inset-0 bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-indigo-900/40 via-slate-950 to-black z-0 pointer-events-none"></div>
    <div class="fixed inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 z-0 pointer-events-none brightness-100 contrast-150"></div>

    <!-- Navbar -->
    <header class="border-b border-white/5 sticky top-0 z-50 glass-panel">
        <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-br from-cyan-500 to-blue-600 p-2.5 rounded-xl shadow-lg shadow-cyan-500/20 ring-1 ring-white/20">
                    <i data-lucide="cpu" class="w-6 h-6 text-white"></i>
                </div>
                <div class="flex flex-col">
                    <span class="font-display font-bold text-2xl tracking-tight text-white leading-none">
                        Smart Triage <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-indigo-400">System</span>
                    </span>
                    <span class="text-[10px] uppercase tracking-[0.2em] text-slate-400 font-medium flex items-center gap-2">
                        RPi 4 • Flask AI 
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse ml-2"></span>
                        <span class="text-emerald-500/80">ONLINE</span>
                    </span>
                </div>
            </div>
            
            <!-- Clock -->
            <div class="hidden md:flex items-center gap-2 text-slate-400 font-mono text-sm bg-slate-900/50 px-3 py-1 rounded-lg border border-white/5">
                <i data-lucide="clock" class="w-4 h-4"></i>
                <span id="clock">00:00:00</span>
            </div>
        </div>
    </header>

    <main class="relative z-10 max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left: Video Feed -->
            <div class="lg:col-span-7 flex flex-col gap-4">
                <div class="relative rounded-3xl overflow-hidden border border-white/10 bg-black shadow-2xl shadow-black/50 group ring-1 ring-white/5">
                    <!-- Video Header -->
                    <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/90 to-transparent z-20 flex justify-between items-start pointer-events-none">
                        <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/20 border border-red-500/50 backdrop-blur-md">
                            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                            <span class="text-xs font-bold text-red-100 tracking-wider">LIVE FEED</span>
                        </div>
                        <i data-lucide="scan-face" class="w-6 h-6 text-white/50"></i>
                    </div>

                    <!-- Video Source from Flask -->
                    <div class="aspect-video bg-slate-900 flex items-center justify-center relative">
                        <img src="{{ url_for('video_feed') }}" class="w-full h-full object-cover opacity-90" alt="Video Feed">
                        
                        <!-- Grid Overlay Decoration -->
                        <div class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:40px_40px] pointer-events-none"></div>
                    </div>
                </div>

                <!-- System Logs (Simulasi) -->
                <div class="p-4 rounded-xl border border-white/5 bg-slate-900/40 font-mono text-xs text-slate-500 flex flex-col gap-1">
                    <p>> Memulai protokol skrining...</p>
                    <p>> Kamera aktif [OK]</p>
                    <p>> Sensor MLX90614 terhubung [OK]</p>
                    <p>> Sensor MAX30102 terhubung [OK]</p>
                    <p class="text-cyan-500 animate-pulse">> Menunggu subjek...</p>
                </div>
            </div>

            <!-- Right: Data Metrics -->
            <div class="lg:col-span-5 flex flex-col gap-4">
                
                <!-- Status Card (Besar) -->
                <!-- Kita sediakan 2 state visual yang akan di-toggle class-nya oleh JS -->
                <div id="status-card" class="p-8 rounded-3xl border transition-all duration-500 shadow-xl flex flex-col items-center justify-center text-center gap-4 relative overflow-hidden bg-slate-900/50 border-white/10 min-h-[220px]">
                    
                    <!-- Icon Container -->
                    <div id="status-icon-bg" class="p-4 rounded-full mb-2 bg-slate-800 text-slate-400 transition-colors duration-500">
                        <!-- Masukkan kedua icon, toggle 'hidden' class -->
                        <i id="icon-wait" data-lucide="loader-2" class="w-10 h-10 animate-spin"></i>
                        <i id="icon-allow" data-lucide="shield-check" class="w-10 h-10 hidden"></i>
                        <i id="icon-deny" data-lucide="shield-alert" class="w-10 h-10 hidden"></i>
                    </div>
                    
                    <div class="relative z-10">
                        <h2 id="status-text" class="text-4xl md:text-5xl font-display font-bold tracking-tight mb-2 text-slate-200 transition-colors duration-300">
                            MEMUAT...
                        </h2>
                        <p id="status-msg" class="text-slate-400 font-medium text-lg transition-colors duration-300">Menghubungkan sensor...</p>
                    </div>

                    <!-- Background Glow Effect -->
                    <div id="status-glow" class="absolute inset-0 bg-gradient-to-b from-transparent to-transparent opacity-20 transition-all duration-500"></div>
                </div>

                <!-- Metrics Grid -->
                <div class="grid grid-cols-2 gap-4">
                    
                    <!-- Suhu -->
                    <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group hover:border-amber-500/30 transition-colors">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-amber-500/5 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                        <div class="flex items-start justify-between mb-4 relative z-10">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Suhu Tubuh</span>
                            <i data-lucide="thermometer" class="w-5 h-5 text-amber-500"></i>
                        </div>
                        <div class="flex items-baseline gap-1 relative z-10">
                            <span id="val-suhu" class="text-4xl font-display font-bold text-white transition-colors duration-300">0.0</span>
                            <span class="text-sm text-slate-400">°C</span>
                        </div>
                        <div class="w-full bg-slate-800 h-1.5 rounded-full mt-3 overflow-hidden">
                            <div id="bar-suhu" class="h-full rounded-full bg-amber-500 transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- SpO2 -->
                    <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group hover:border-cyan-500/30 transition-colors">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-cyan-500/5 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                        <div class="flex items-start justify-between mb-4 relative z-10">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">SpO2</span>
                            <i data-lucide="activity" class="w-5 h-5 text-cyan-500"></i>
                        </div>
                        <div class="flex items-baseline gap-1 relative z-10">
                            <span id="val-spo2" class="text-4xl font-display font-bold text-white transition-colors duration-300">0</span>
                            <span class="text-sm text-slate-400">%</span>
                        </div>
                        <div class="w-full bg-slate-800 h-1.5 rounded-full mt-3 overflow-hidden">
                            <div id="bar-spo2" class="h-full rounded-full bg-cyan-500 transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Mask Status -->
                    <div class="col-span-2 glass-panel p-5 rounded-2xl flex items-center justify-between hover:bg-slate-900/60 transition-colors">
                        <div class="flex items-center gap-4">
                            <div id="mask-icon-bg" class="p-3 rounded-xl bg-slate-800 text-slate-400 transition-colors duration-300">
                                <!-- Dua icon untuk toggle -->
                                <i id="icon-mask-no" data-lucide="user-x" class="w-6 h-6"></i>
                                <i id="icon-mask-yes" data-lucide="user-check" class="w-6 h-6 hidden"></i>
                            </div>
                            <div>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block">Deteksi Masker</span>
                                <span id="val-masker" class="text-xl font-bold text-slate-200 transition-colors duration-300">--</span>
                            </div>
                        </div>
                        
                        <!-- Mini visual indicator -->
                        <div id="mask-indicator" class="w-3 h-3 rounded-full bg-slate-700"></div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Icons once at start
        lucide.createIcons();

        // Clock Update
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID');
        }, 1000);

        // Elements Cache (Supaya tidak querySelector terus menerus)
        const els = {
            suhuVal: document.getElementById('val-suhu'),
            suhuBar: document.getElementById('bar-suhu'),
            spo2Val: document.getElementById('val-spo2'),
            spo2Bar: document.getElementById('bar-spo2'),
            maskVal: document.getElementById('val-masker'),
            maskBg: document.getElementById('mask-icon-bg'),
            maskIconNo: document.getElementById('icon-mask-no'),
            maskIconYes: document.getElementById('icon-mask-yes'),
            maskInd: document.getElementById('mask-indicator'),
            statusCard: document.getElementById('status-card'),
            statusText: document.getElementById('status-text'),
            statusMsg: document.getElementById('status-msg'),
            statusIconBg: document.getElementById('status-icon-bg'),
            statusGlow: document.getElementById('status-glow'),
            iconWait: document.getElementById('icon-wait'),
            iconAllow: document.getElementById('icon-allow'),
            iconDeny: document.getElementById('icon-deny'),
        };

        function updateDashboard() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    // === 1. Update SUHU ===
                    els.suhuVal.innerText = data.suhu;
                    const isSuhuDanger = data.suhu > 37.5;
                    
                    els.suhuVal.className = `text-4xl font-display font-bold transition-colors duration-300 ${isSuhuDanger ? 'text-red-500' : 'text-white'}`;
                    
                    // Bar Width Calculation
                    const suhuPct = Math.min(Math.max((data.suhu - 35) / 5 * 100, 5), 100);
                    els.suhuBar.style.width = `${suhuPct}%`;
                    els.suhuBar.className = `h-full rounded-full transition-all duration-1000 ease-out ${isSuhuDanger ? 'bg-red-500' : 'bg-amber-500'}`;

                    // === 2. Update SPO2 ===
                    els.spo2Val.innerText = data.spo2;
                    const isSpo2Danger = data.spo2 < 95;
                    
                    els.spo2Val.className = `text-4xl font-display font-bold transition-colors duration-300 ${isSpo2Danger ? 'text-red-500' : 'text-white'}`;
                    
                    els.spo2Bar.style.width = `${data.spo2}%`;
                    els.spo2Bar.className = `h-full rounded-full transition-all duration-1000 ease-out ${isSpo2Danger ? 'bg-red-500' : 'bg-cyan-500'}`;

                    // === 3. Update MASKER ===
                    const hasMask = data.masker; // boolean true/false
                    els.maskVal.innerText = hasMask ? "Terdeteksi" : "Tidak Terdeteksi";
                    els.maskVal.className = `text-xl font-bold transition-colors duration-300 ${hasMask ? "text-emerald-400" : "text-red-400"}`;
                    
                    els.maskBg.className = `p-3 rounded-xl transition-colors duration-300 ${hasMask ? "bg-emerald-500/10 text-emerald-500" : "bg-red-500/10 text-red-500"}`;
                    els.maskInd.className = `w-3 h-3 rounded-full transition-colors ${hasMask ? "bg-emerald-500 shadow-[0_0_10px_#10b981]" : "bg-red-500 shadow-[0_0_10px_#ef4444]"}`;

                    // Toggle Icons (Efficiently)
                    if (hasMask) {
                        els.maskIconNo.classList.add('hidden');
                        els.maskIconYes.classList.remove('hidden');
                    } else {
                        els.maskIconNo.classList.remove('hidden');
                        els.maskIconYes.classList.add('hidden');
                    }

                    // === 4. Update STATUS UTAMA ===
                    const isAllowed = data.status_akses === 'DIIZINKAN';
                    
                    els.statusText.innerText = data.status_akses;
                    els.statusMsg.innerText = data.pesan;

                    // Hilangkan icon loading
                    els.iconWait.classList.add('hidden');

                    if (isAllowed) {
                        // Style: Green / Allowed
                        els.statusCard.className = "p-8 rounded-3xl border transition-all duration-500 shadow-xl flex flex-col items-center justify-center text-center gap-4 relative overflow-hidden bg-emerald-950/20 border-emerald-500/30 shadow-emerald-900/20 min-h-[220px]";
                        els.statusText.className = "text-4xl md:text-5xl font-display font-bold tracking-tight mb-2 text-emerald-400 drop-shadow-sm";
                        els.statusIconBg.className = "p-4 rounded-full mb-2 bg-emerald-500 text-white shadow-lg shadow-emerald-500/40 scale-110 transition-transform duration-500";
                        els.statusGlow.className = "absolute inset-0 bg-gradient-to-b from-emerald-500/10 to-transparent opacity-100 transition-all duration-500";
                        
                        els.iconAllow.classList.remove('hidden');
                        els.iconDeny.classList.add('hidden');
                    } else {
                        // Style: Red / Denied
                        els.statusCard.className = "p-8 rounded-3xl border transition-all duration-500 shadow-xl flex flex-col items-center justify-center text-center gap-4 relative overflow-hidden bg-red-950/20 border-red-500/30 shadow-red-900/20 min-h-[220px]";
                        els.statusText.className = "text-4xl md:text-5xl font-display font-bold tracking-tight mb-2 text-red-500 drop-shadow-sm";
                        els.statusIconBg.className = "p-4 rounded-full mb-2 bg-red-500 text-white shadow-lg shadow-red-500/40 scale-100 transition-transform duration-500";
                        els.statusGlow.className = "absolute inset-0 bg-gradient-to-b from-red-500/10 to-transparent opacity-100 transition-all duration-500";

                        els.iconAllow.classList.add('hidden');
                        els.iconDeny.classList.remove('hidden');
                    }

                })
                .catch(err => {
                    console.error("Error fetching API:", err);
                    els.statusText.innerText = "OFFLINE";
                    els.statusText.className = "text-4xl md:text-5xl font-display font-bold tracking-tight mb-2 text-slate-500";
                    els.statusMsg.innerText = "Koneksi ke server terputus";
                    els.iconWait.classList.remove('hidden');
                    els.iconAllow.classList.add('hidden');
                    els.iconDeny.classList.add('hidden');
                });
        }

        // Jalankan update setiap 1000ms (1 detik)
        setInterval(updateDashboard, 1000);
        
        // Initial Call
        updateDashboard();
    </script>
</body>
</html>